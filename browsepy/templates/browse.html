{% extends "base.html" %}

{% macro draw_widget(f, widget) -%}
  {%- if widget.type == 'button' or widget.type == 'link'-%}
    <a
      href="{{ url_for(widget.endpoint, path=f.urlpath) }}"
      class="
        {{- widget.type -}}
        {%- if widget.text %} text{% endif -%}
        {%- if widget.css %} {{ widget.css }}{% endif -%}"
      >{{ widget.text or '' }}</a>
  {%- elif widget.type == 'script' -%}
    <script
      src="{{ widget.src or url_for(widget.endpoint, filename=widget.filename) }}"
      ></script>
  {%- elif widget.type == 'stylesheet' -%}
    <link
      rel="stylesheet"
      type="text/css"
      href="{{ widget.href or url_for(widget.endpoint, filename=widget.filename) }}"/>
  {%- elif widget.type == 'upload' -%}
    <form class="upload autosubmit{% if widget.css %} {{ widget.css }}{% endif %}"
          method="post"
          action="{{ widget.action or url_for(widget.endpoint, path=file.urlpath) }}"
          enctype="multipart/form-data">
      <label>
        <span>{{ widget.text or 'Upload' }}</span>
        <input class="button text suggested" type="file" name="file[]" multiple=""/>
      </label>
      <input class="button text" type="submit" value="{{ widget.text or 'Upload' }}"/>
    </form>
  {%- elif widget.type == 'html' -%}
    {{ widget.html|safe }}
  {%- endif -%}
{%- endmacro %}

{% macro draw_widgets(f, place) -%}
  {%- for widget in f.widgets -%}
    {%- if widget.place == place -%}
      {{ draw_widget(f, widget) }}
    {%- endif -%}
  {%- endfor -%}
{%- endmacro %}

{% macro th(text, property=None, type='text', colspan=1) -%}
<th{% if colspan > 1 %} colspan="{{ colspan }}"{% endif %}>
  {% if property %}
    {% set urlpath = file.urlpath or None %}
    {% set property_desc = '-{}'.format(property) %}
    {% set prop = property_desc if sort_property == property else property %}
    {% set active = ' active' if sort_property in (property, property_desc) else '' %}
    {% set desc = ' desc' if sort_property == property_desc else '' %}
    <a href="{{ url_for('sort', path=urlpath, property=prop) }}"
       class="{{type}} sorting{{active}}{{desc}}"
       >{{ text }}</a>
  {% else %}
    {{- text -}}
  {% endif %}
</th>
{%- endmacro %}

{% block title %}
  {{- super() -}}
  {%- if file and file.urlpath %} - {{ file.urlpath }}{% endif -%}
{% endblock %}

{% block styles %}
  {{ super() }}
  {{ draw_widgets(file, 'styles') }}
{% endblock %}

{% block head %}
  {{ super() }}
  {{ draw_widgets(file, 'head') }}
{% endblock %}

{% block scripts %}
  {{ super() }}
  {{ draw_widgets(file, 'scripts') }}
{% endblock %}

{% block header %}
<h1>{{ breadcrumbs(file) }}</h1>
{% endblock %}

{% block content %}
{% block content_header %}
<header>{{ draw_widgets(file, 'header') }}</header>
{% endblock %}

{% block content_table %}
{% if file.is_empty %}
    <p>No files in directory</p>
{% else %}
    <table class="browser">
        <thead>
            <tr>
              {{ th('Name', 'text', 'text', 3) }}
              {{ th('Mimetype', 'type') }}
              {{ th('Modified', 'modified', 'numeric') }}
              {{ th('Size', 'size', 'numeric') }}
            </tr>
        </thead>
        <tbody>
            {% for f in file.listdir(sortkey=sort_fnc, reverse=sort_reverse) %}
                <tr{% if f.name %} name="row-{{ f.name }}"{% endif %}>
                    {% if f.link %}
                      <td class="icon {{ f.link.icon }}"></td>
                      <td>{{ draw_widget(f, f.link) }}</td>
                    {% else %}
                      <td></td>
                      <td></td>
                    {% endif %}
                    <td>{{ draw_widgets(f, 'entry-actions') }}</td>
                    <td>{{ f.type or '' }}</td>
                    <td>{{ f.modified or '' }}</td>
                    <td>{{ f.size or '' }}</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
{% endif %}
{% endblock %}

{% block content_footer %}
<footer>{{ draw_widgets(file, 'footer') }}</footer>
{% endblock %}
{% endblock %}
